---
layout: single
title: "ğŸ™[ìŠ¤í”„ë§ ì‹œíë¦¬í‹° OAuth2] oauth2Client()"
categories:
  - springBoot
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "sidebar-category"
---

# 1. OAuth2ClientConfigurer ì´ˆê¸°í™” ë° ì„¤ì •

![Image](https://github.com/user-attachments/assets/60c1fc62-29ea-4435-b43e-8fb809488a5a)

![Image](https://github.com/user-attachments/assets/8c0964ff-dd6b-4e3c-b386-54c51edca687)

# 2. OAuth2AuthorizationCodeGrantFilter â€“ Authorization Code Grant Support

## âœ”ï¸ê°œë…

- Authorization Code Grant ë°©ì‹ìœ¼ë¡œ ê¶Œí•œ ë¶€ì—¬ ìš”ì²­ì„ ì§€ì›í•˜ëŠ” í•„í„°
- ì¸ê°€ì„œë²„ë¡œë¶€í„° ë¦¬ë‹¤ì´ë ‰íŠ¸ ë˜ë©´ì„œ ì „ë‹¬ëœ code ë¥¼ ì¸ê°€ì„œë²„ì˜ Access Token ìœ¼ë¡œ êµí™˜í•œë‹¤.
- OAuth2AuthorizedClientRepository ë¥¼ ì‚¬ìš©í•˜ì—¬ OAuth2AuthorizedClient ë¥¼ ì €ì¥ í›„ í´ë¼ì´ì–¸íŠ¸ì˜ Redirect Uri ë¡œ ì´ë™í•œë‹¤
- ![Image](https://github.com/user-attachments/assets/100ad224-0e0c-44d6-a0f4-f2e63cbd42a7)

- **ì‹¤í–‰ ì¡°ê±´**
  - ìš”ì²­ íŒŒë¼ë¯¸í„°ì— code ì™€ state ê°’ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  - OAuth2AuthorizationRequest ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸

# 3. OAuth2AuthorizedClient â€“ ê¶Œí•œë¶€ì—¬ í´ë¼ì´ì–¸íŠ¸

## âœ”ï¸ê°œë…

- OAuth2AuthorizedClient ëŠ” ì¸ê°€ë°›ì€ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì˜ë¯¸í•˜ëŠ” í´ë˜ìŠ¤ë‹¤.
- ìµœì¢… ì‚¬ìš©ì(ë¦¬ì†ŒìŠ¤ ì†Œìœ ì)ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´, í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¸ê°€ëœ í´ë¼ì´ì–¸íŠ¸ë¡œ ê°„ì£¼í•œë‹¤
- OAuth2AuthorizedClient ëŠ” AccessToken ê³¼ RefreshToken ì„ ClientRegistration (í´ë¼ì´ì–¸íŠ¸)ì™€ ê¶Œí•œì„ ë¶€ì—¬í•œ ìµœì¢… ì‚¬ìš©ìì¸ Principalê³¼ í•¨ê»˜ ë¬¶ì–´ ì¤€ë‹¤
- OAuth2AuthorizedClient ì˜ AccessToken ì„ ì‚¬ìš©í•´ì„œ ë¦¬ì†ŒìŠ¤ ì„œë²„ì˜ ìì›ì— ì ‘ê·¼ í•  ìˆ˜ ìˆìœ¼ë©° ì¸ê°€ì„œë²„ì™€ì˜ í†µì‹ ìœ¼ë¡œ í† í°ì„ ê²€ì¦í•  ìˆ˜ ìˆë‹¤
- OAuth2AuthorizedClient ì˜ ClientRegistration ê³¼ AccessToken ì„ ì‚¬ìš©í•´ì„œ UserInfo ì—”ë“œ í¬ì¸íŠ¸ë¡œ ìš”ì²­í•  ìˆ˜ ìˆë‹¤
- ![Image](https://github.com/user-attachments/assets/f142bc4f-b5c2-433f-a0a1-cde11a41647b)

- **OAuth2AuthorizedClientRepository**

  - OAuth2AuthorizedClientRepository ëŠ” ë‹¤ë¥¸ ì›¹ ìš”ì²­ì´ ì™€ë„ ë™ì¼í•œ OAuth2AuthorizedClient ë¥¼ ìœ ì§€í•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹í•œë‹¤.
  - OAuth2AuthorizedClientService ì—ê²Œ OAuth2AuthorizedClient ì˜ ì €ì¥, ì¡°íšŒ, ì‚­ì œ ì²˜ë¦¬ë¥¼ ìœ„ì„í•œë‹¤
  - ![Image](https://github.com/user-attachments/assets/f70ce141-8091-4a55-947a-0d52f8d882c8)

- **OAuth2AuthorizedClientService**

  - OAuth2AuthorizedClientService ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ OAuth2AuthorizedClient ë¥¼ ê´€ë¦¬(ì €ì¥, ì¡°íšŒ, ì‚­ì œ )í•˜ëŠ” ì¼ì´ë‹¤.
  - ![Image](https://github.com/user-attachments/assets/1c43c7dc-1f12-412a-83ad-df5ba1026718)

- **ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í™œìš©**
  - OAuth2AuthorizedClientRepository ë‚˜ OAuth2AuthorizedClientService ëŠ” OAuth2AuthorizedClient ì—ì„œ OAuth2AccessToken ì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ë¯€ë¡œ ë³´í˜¸ì¤‘ì¸ ë¦¬ì†ŒìŠ¤ ìš”ì²­ì„ ì‹œì‘í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤
  - ![Image](https://github.com/user-attachments/assets/6b39a9d3-7240-4f71-a138-bc48dbbf334a)

# 4. DefaultOAuth2AuthorizedClientManager â€“ í´ë¼ì´ì–¸íŠ¸ ì¸ê°€ ê´€ë¦¬ì

## 4-1). ê°œë…

### âœ”ï¸ê°œë…

- OAuth2AuthorizedClient ë¥¼ ì „ë°˜ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
- OAuth2AuthorizedClientProvider ë¡œ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ì— ê¶Œí•œ ë¶€ì—¬
  - Client Credentials Flow
  - Resource Owner Password Flow
  - Refresh Token Flow
- OAuth2AuthorizedClientService ë‚˜ OAuth2AuthorizedClientRepository ì— OAuth2AuthorizedClient ì €ì¥ì„ ìœ„ì„í•œ í›„ OAuth2AuthorizedClient ìµœì¢… ë°˜í™˜
- ì‚¬ìš©ì ì •ì˜ OAuth2AuthorizationSuccessHandler ë° OAuth2AuthorizationFailureHandler ë¥¼ êµ¬ì„±í•˜ì—¬ ì„±ê³µ/ì‹¤íŒ¨ ì²˜ë¦¬ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.
- invalid_grant ì˜¤ë¥˜ë¡œ ì¸í•´ ê¶Œí•œ ë¶€ì—¬ ì‹œë„ê°€ ì‹¤íŒ¨í•˜ë©´ ì´ì „ì— ì €ì¥ëœ OAuth2AuthorizedClientê°€ OAuth2AuthorizedClientRepository ì—ì„œ ì œê±°ëœë‹¤
- ![Image](https://github.com/user-attachments/assets/698da69c-c176-44c6-b44e-5957812af9a6)

### âœ”ï¸íŠ¹ì§•

![Image](https://github.com/user-attachments/assets/b9173946-f7cc-4126-a640-8e108eb9482e)

### âœ”ï¸êµ¬ì¡°

![Image](https://github.com/user-attachments/assets/20b78c8c-e6de-43eb-91bf-b4271c42b8ff)

### âœ”ï¸ìƒì„±

```java
@Bean
public OAuth2AuthorizedClientManager authorizedClientManager(ClientRegistrationRepository clientRegistrationRepository,
OAuth2AuthorizedClientRepository authorizedClientRepository) {
	OAuth2AuthorizedClientProvider authorizedClientProvider =
		OAuth2AuthorizedClientProviderBuilder.builder()
			.authorizationCode()
			.refreshToken()
			.clientCredentials()
			.password()
			.build();

	DefaultOAuth2AuthorizedClientManager authorizedClientManager =
		new DefaultOAuth2AuthorizedClientManager(
			clientRegistrationRepository, authorizedClientRepository);
	authorizedClientManager.setAuthorizedClientProvider(authorizedClientProvider);

	return authorizedClientManager;
}
```

## 4-2). ì¸ê°€ì„œë²„ì™€ ì—°ë™í•˜ì—¬ ë¡œê·¸ì¸ êµ¬í˜„

### 4-2-1). ê¸°ë³¸ í™˜ê²½ êµ¬ì„±

**âœ”ï¸ê°œìš”**

- ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ OAuth2Login í•„í„°ì— ì˜í•œ ìë™ ì¸ì¦ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šê³  DefaultOAuth2AuthorizedClientManager í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ Spring MVC ì—ì„œ ì§ì ‘ ì¸ì¦ì²˜ë¦¬ë¥¼ í•˜ëŠ” ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•œë‹¤.

```java
@Bean
SecurityFilterChain oauth2SecurityFilterChain(HttpSecurity http) throws Exception {
	http.authorizeRequests((requests) -> requests.antMatchers("/","/oauth2Login","/client").permitAll().anyRequest().authenticated());
	http
		// .oauth2Login().and()
		.oauth2Client();
	http.logout().invalidateHttpSession(true)
		.deleteCookies("JSESSIONID")
		.clearAuthentication(true);

	return http.build();
}
```

**âœ”ï¸ê¸°ë³¸ êµ¬ì„±**

- AppConfig â€“ DefaultOAuth2AuthorizedClientManager ë¹ˆ ìƒì„± ë° ì„¤ì • ì´ˆê¸°í™”
- DefaultOAuth2AuthorizedClientManager â€“ OAuth2 ê¶Œí•œ ë¶€ì—¬ íë¦„ì„ ì²˜ë¦¬
- LoginController â€“ DefaultOAuth2AuthorizedClientManager ë¥¼ ì‚¬ìš©í•´ì„œ ë¡œê·¸ì¸ ì²˜ë¦¬
- home.html â€“ ì¸ì¦ë°›ì€ ì‚¬ìš©ìë§Œ ì ‘ê·¼ê°€ëŠ¥
- Index.html, client.html â€“ ì•„ë¬´ë‚˜ ì ‘ê·¼ ê°€ëŠ¥
- application.yml - ê¶Œí•œ ë¶€ì—¬ ìœ í˜•ì„ client_credentials, password, refresh íƒ€ì…ìœ¼ë¡œ ì„¤ì •í•œë‹¤

**âœ”ï¸ë¡œê·¸ì¸ êµ¬í˜„ ìˆœì„œ**

1. DefaultOAuth2AuthorizedClientManager ë¹ˆ ìƒì„± ë° íŒŒë¼ë¯¸í„° ì´ˆê¸° ê°’ë“¤ì„ ì •ì˜í•œë‹¤
2. ê¶Œí•œ ë¶€ì—¬ ìœ í˜•ì— ë”°ë¼ ìš”ì²­ì´ ì´ë£¨ì–´ë„ë¡ application.yml ì„¤ì •ì„ ì¡°ì •í•œë‹¤
3. /oauth2Login ì£¼ì†Œë¡œ ê¶Œí•œ ë¶€ì—¬ íë¦„ì„ ìš”ì²­í•œë‹¤
4. DefaultOAuth2AuthorizedClientManager ì—ê²Œ ê¶Œí•œ ë¶€ì—¬ë¥¼ ìš”ì²­í•œë‹¤
5. ê¶Œí•œ ë¶€ì—¬ê°€ ì„±ê³µí•˜ë©´ OAuth2AuthorizationSuccessHandler ë¥¼ í˜¸ì¶œí•˜ì—¬ ì¸ì¦ ì´í›„ ì‘ì—…ì„ ì§„í–‰í•œë‹¤
   1. DefaultOAuth2AuthorizedClientManager ì˜ ìµœì¢… ë°˜í™˜ê°’ì¸ OAuth2AuthorizedClient ë¥¼ OAuth2AuthorizedClientRepository ì— ì €ì¥í•œë‹¤
6. OAuth2AuthorizedClient ì—ì„œ Access Token ì„ ì°¸ì¡°í•˜ì—¬ /userinfo ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ìœ¼ë¡œ ìµœì¢… ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
7. ì‚¬ìš©ì ì •ë³´ì™€ ê¶Œí•œì„ ê°€ì§€ê³  ì¸ì¦ê°ì²´ë¥¼ ë§Œë“  í›„ SecurityContext ì— ì €ì¥í•˜ê³  ì¸ì¦ì„ ì™„ë£Œí•œë‹¤
8. ì¸ì¦ì´ ì„±ê³µí•˜ë©´
9. 1~8 ë²ˆì˜ ê³¼ì •ì„ ì»¤ìŠ¤í…€ í•„í„°ë¥¼ ë§Œë“¤ì–´ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•œë‹¤

### 4-2-2). Client Credentials Flow

![Image](https://github.com/user-attachments/assets/7463f25b-b808-48c4-9a0a-19f57a69d976)

### 4-2-3). Resource Owner Password Flow

![Image](https://github.com/user-attachments/assets/8849936e-e145-4e88-8d35-6f3881b8b261)

![Image](https://github.com/user-attachments/assets/fe4273dc-7076-4b6d-a134-399e6d723105)

### 4-2-4). Refresh Token Flow

![Image](https://github.com/user-attachments/assets/85fa06f2-5d69-4abf-ae8f-1d70d2709b5e)

# 5. OAuth2 ì»¤ìŠ¤í…€ ë¡œê·¸ì¸ í•„í„° êµ¬í˜„

![Image](https://github.com/user-attachments/assets/bf693f27-982e-4750-9022-abbd02eabc00)

# 6. @RegisteredOAuth2AuthorizedClient

### âœ”ï¸@RegisteredOAuth2AuthorizedClient

- íŒŒë¼ë¯¸í„°ë¥¼ OAuth2AuthorizedClient íƒ€ì… ì¸ìë¡œ ë¦¬ì¡¸ë¸Œí•´ì¤€ë‹¤
- OAuth2AuthorizedClientArgumentResolver ì—ì„œ ìš”ì²­ì„ ê°€ë¡œì±„ì–´ ìœ í˜•ë³„ë¡œ ê¶Œí•œ ë¶€ì—¬ íë¦„ì„ ì‹¤í–‰í•˜ë„ë¡ í•œë‹¤
- ì´ ë°©ë²•ì€ OAuth2AuthorizedClientManager ë‚˜ OAuth2AuthorizedClientService ë¡œ OAuth2AuthorizedClient ì— ì ‘ê·¼í•˜ëŠ” ê²ƒë³´ë‹¤ í¸ë¦¬í•˜ë‹¤
  ```java
  @GetMapping("/")
  public String index(@RegisteredOAuth2AuthorizedClient(â€œkeycloak") OAuth2AuthorizedClient authorizedClient) {
  		OAuth2AccessToken accessToken = authorizedClient.getAccessToken();
  	return "index";
  }
  ```
  â¡ï¸ @RegisteredOAuth2AuthorizedClient ë¥¼ ì„ ì–¸í•˜ê³  OAuth2AuthorizedClient ë¥¼ ì¸ìë¡œ ì§€ì •í•œ ë©”ì„œë“œì´ë©´ OAuth2AuthorizedClientArgumentResolver ê°€ ì‹¤í–‰ë˜ë©´ì„œ OAuth2AuthorizedClientManager ë¥¼ í†µí•´ ì¸ê°€ ì²˜ë¦¬í•œë‹¤
  ![Image](https://github.com/user-attachments/assets/eb77a5ed-7b7c-4240-8498-4131b97df326)

![Image](https://github.com/user-attachments/assets/23326a85-8f62-45f2-a0e9-6f637d12f05c)
