---
layout: single
title: "π‘€[μ¤ν”„λ§ μ‹νλ¦¬ν‹° OAuth2] oauth2ResourceServer().jwt()"
categories:
  - springBoot
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "sidebar-category"
---

# 1. JWT API μ„¤μ • λ° κ²€μ¦ ν”„λ΅μ„Έμ¤ μ΄ν•΄

## β“ μ„¤μ • ν΄λμ¤ μƒμ„±

```java
@Configuration(proxyBeanMethods = false)
public class OAuth2ResourceServerConfig {

	@Bean
	SecurityFilterChain jwtSecurityFilterChain(HttpSecurity http) throws Exception {
		http.authorizeRequests((requests) -> requests.anyRequest().authenticated());
		http.oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt); // jwt ν† ν°μ„ κ²€μ¦ν•λ” λΉλ“¤κ³Ό ν΄λμ¤λ¥Ό μƒμ„±ν•κ³  μ΄κΈ°ν™” ν•¨
		return http.build();
	}

}
```

- API μ„¤μ •
  - SecurityFilterChain νƒ€μ…μ λΉμ„ μƒμ„±ν•΄μ„ λ³΄μ• ν•„ν„°λ¥Ό κµ¬μ„±ν•λ‹¤
  - HttpSecurity μ— μλ” oauth2ResourceServer().jwt() API λ¥Ό μ •μν•κ³  λΉλ“ν•λ‹¤
    <img src="/assets/images/springBoot/image00000005.png">

## β“ κ²€μ¦ ν”„λ΅μ„Έμ¤ μ΄ν•΄

```yaml
spring.security.oauth2.resourceserver.jwt.issuer-uri = http://localhost:8080/realms/oauth2
```

- ν”„λ΅νΌν‹°λ¥Ό μ„¤μ •ν•λ©΄ JWTλ΅ μΈμ½”λ”©ν• Bearer ν† ν°μ„ κ²€μ¦ν•λ” λ¦¬μ†μ¤ μ„λ²„κ°€ μλ™μΌλ΅ μ„¤μ •λλ‹¤.
- Open ID Connect Provider μ„¤μ • μ—”λ“ν¬μΈνΈ λλ” μΈκ°€ μ„λ²„ λ©”νƒ€λ°μ΄ν„° μ—”λ“ν¬μΈνΈλ¥Ό κ²€μƒ‰ν•΄μ„ jwk-set-url μ—”λ“ν¬μΈνΈλ¥Ό μ°Ύμ•„ κ²€μ¦μ„ μ§„ν–‰ν•λ‹¤
- λ‘κ°€μ§€ κ²€μ¦ μ „λµμ„ μ„¤μ •ν•λ‹¤
  - λ¦¬μ†μ¤ μ„λ²„λ” μΈκ°€μ„λ²„μ jwk-set-uri μ—”λ“ν¬μΈνΈλ΅ μ ν¨ν• κ³µκ°ν‚¤λ¥Ό μ§μν•κΈ° μ„ν• κ²€μ¦ μ „λµμ„ μ„¤μ •ν•λ‹¤
  - Issuer-uri(<http://localhost:8080/realms/oauth2>) μ— λ€ν• κ° JWT ν΄λ μ„μ„ κ²€μ¦ν•  μ „λµμ„ μ„¤μ •ν•λ‹¤

### β“ κ²€μ¦ μμ„

1. ν΄λΌμ΄μ–ΈνΈκ°€ Authorization Bearer token-value λ¥Ό ν—¤λ”μ— λ‹΄μ•„μ„ μ”μ²­ν•λ‹¤
2. λ¦¬μ†μ¤ μ„λ²„λ” μ”μ²­ν• ν† ν°μ΄ Bearer ν† ν° μ‚¬μ–‘μ— λ¶€ν•©ν•λ”μ§€ κ²€μ‚¬ν•λ‹¤
3. μΈκ°€μ„λ²„μ—μ„ JWT ν† ν°μ— μ„λ…ν• κ°μΈν‚¤μ™€ λ§¤μΉ­ν•λ” κ³µκ°ν‚¤λ¥Ό jwk-set-url μ—”λ“ν¬μΈνΈ μ”μ²­μΌλ΅ κ°€μ Έμ™€μ„ μ²«λ²μ§Έ κ²€μ¦μ„ μ§„ν–‰ν•λ‹¤.
4. JWTμ— μλ” exp, nbf, iss ν΄λ μ„μ μ •λ³΄κ°€ κΈ°μ¤€μ— λ¶€ν•©ν•λ”μ§€ λ‘λ²μ§Έ κ²€μ¦μ„ μ§„ν–‰ν•λ‹¤
5. κ²€μ¦μ— μ„±κ³µν•λ©΄ Jwt κ°μ²΄λ¥Ό μƒμ„±ν•κ³  claims μ •λ³΄μ— μλ” scope λ¥Ό μ¶”μ¶ν•΄μ„ μ‹νλ¦¬ν‹°μ κ¶ν•μ— λ§¤ν•‘ν•λ‹¤ (SCOPE_profile, SCOPE_email)
6. Authentication κ°μ²΄λ¥Ό μƒμ„±ν•κ³  Jwt κ°μ²΄λ¥Ό principal μ†μ„±μ—λ” μ €μ¥ν•λ‹¤
7. Authentication λ¥Ό SecurityContext μ— μ €μ¥ν•κ³  μΈμ¦μ„ μ™„λ£ν•λ‹¤

<img src="/assets/images/springBoot/image00000006.png">

# 2. JwtDecoder μ΄ν•΄

## 2-1). μ†κ° λ° μ„Έλ¶€ νλ¦„

### β“ JwtDecoder μ†κ°

- <b>JwtDecoder λ” λ¬Έμμ—΄λ΅ λ JWT(JSON Web Token)λ¥Ό μ»΄ν©νΈ ν΄λ μ„ ν‘ν„ ν•μ‹μ—μ„ <span style="color: red">Jwt μΈμ¤ν„΄μ¤λ΅ "λ””μ½”λ”©"</span>ν•λ” μ—­ν• μ„ ν•λ‹¤.</b>
  <img src="/assets/images/springBoot/image00000007.png">
- <b>JwtDecoder λ” JWT κ°€ JSON μ›Ή μ„λ…(JWS) κµ¬μ΅°λ΅ μƒμ„±λ κ²½μ° <span style="color: red">JWS μ„λ…μ— λ€ν• κ²€μ¦</span>μ μ±…μ„μ΄ μλ‹¤.</b>
  <img src="/assets/images/springBoot/image00000008.png">
- <b>κΈ°λ³Έ κµ¬ν„μ²΄λ΅ NimbusJwtDecoder κ°€ μλ‹¤</b>

### β“ NimbusJwtDecoder

<img src="/assets/images/springBoot/image00000009.png">

### β“ κ²€μ¦ μ„Έλ¶€ νλ¦„

- JwtDecoder μ decode() λ¥Ό ν†µν•΄ κ²€μ¦μ— μ„±κ³µν•λ©΄ μµμΆ…μ μΌλ΅ Jwt νƒ€μ…μ μΈμ¦κ°μ²΄λ¥Ό λ°ν™ν•λ‹¤
  <img src="/assets/images/springBoot/image00000010.png">

## 2-2). μƒμ„± λ°©λ²•

### β“ JwtDecoders.fromIssuerLocation()

```java
@Bean
public JwtDecoder jwtDecoder() {
	return JwtDecoders.fromIssuerLocation(properties.getIssuerUri());
}
```

- JwtDecoders.fromIssuerLocation() μ„ νΈμ¶ν•λ©΄ Provider μ„¤μ • λλ” μΈκ°€ μ„λ²„ λ©”νƒ€λ°μ΄ν„° μ—”λ“ν¬μΈνΈλ΅ JWK μ…‹ Uriλ¥Ό μ”μ²­ν•λ‹¤
- μ–΄ν”λ¦¬μΌ€μ΄μ…μ—μ„ λ”°λ΅ μ •μν• JwtDecoder λΉμ΄ μ—†λ‹¤λ©΄ μ¤ν”„λ§ λ¶€νΈκ°€ μ„μ— μλ” λ””ν΄νΈ λΉμ„ λ“±λ΅ν•λ‹¤.

### β“ NimbusJwtDecoder.withJwkSetUri()

```java
@Bean
public JwtDecoder jwtDecoder() {
	return NimbusJwtDecoder.withJwkSetUri(properties.getJwkSetUri())
		.jwsAlgorithm(SignatureAlgorithm.RS512).build();
}
```

- κΈ°λ³Έμ μΌλ΅ μ¤ν”„λ§ λ¶€νΈμ— μν•΄ NimbusJwtDecoder λΉμ΄ μλ™ μƒμ„±λ  κ²½μ° λ¦¬μ†μ¤ μ„λ²„λ” RS256 μ„ μ‚¬μ©ν• ν† ν°λ§ μ‹ λΆ°ν•κ³  μ΄ ν† ν°λ§ κ²€μ¦ν•  μ μλ‹¤
- JwkSetUri μ— μν• κ²€μ¦λ°©μ‹μΌλ΅ NimbusJwtDecoder λ¥Ό μƒμ„±ν•  κ²½μ° μ•κ³ λ¦¬μ¦μ μΆ…λ¥λ¥Ό λ³€κ²½ν•  μ μμΌλ‚ RSA μ•κ³ λ¦¬μ¦μ— ν•ν•΄ λ³€κ²½μ΄ κ°€λ¥ν•κ³  HMAC μ€ μ§€μ›ν•μ§€ μ•λ”λ‹¤
