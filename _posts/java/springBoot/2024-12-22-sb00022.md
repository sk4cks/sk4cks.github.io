---
layout: single
title: "π†‘[μ¤ν”„λ§ μ‹νλ¦¬ν‹° OAuth2] OAuth 2.0 Client Fundamentals"
categories:
  - springBoot
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "sidebar-category"
---

# application.yml / OAuth2ClientProperties

## ν΄λΌμ΄μ–ΈνΈ κ¶ν• λ¶€μ—¬ μ”μ²­ μ‹μ‘

1. ν΄λΌμ΄μ–ΈνΈκ°€ μΈκ°€μ„λ²„λ΅ κ¶ν• λ¶€μ—¬ μ”μ²­μ„ ν•κ±°λ‚ ν† ν° μ”μ²­μ„ ν•  κ²½μ° ν΄λΌμ΄μ–ΈνΈ μ •λ³΄ λ° μ—”λ“ν¬μΈνΈ μ •λ³΄λ¥Ό μ°Έμ΅°ν•΄μ„ μ „λ‹¬ν•λ‹¤
2. application.yml ν™κ²½μ„¤μ • νμΌμ— ν΄λΌμ΄μ–ΈνΈ μ„¤μ •κ³Ό μΈκ°€μ„λ²„ μ—”λ“ν¬μΈνΈ μ„¤μ •μ„ ν•λ‹¤
3. μ΄κΈ°ν™”κ°€ μ§„ν–‰λλ©΄ application.yml μ— μλ” ν΄λΌμ΄μ–ΈνΈ λ° μ—”λ“ν¬μΈνΈ μ •λ³΄κ°€ OAuth2ClientProperties μ κ° μ†μ„±μ— λ°”μΈλ”© λλ‹¤
4. OAuth2ClientProperties μ— λ°”μΈλ”© λμ–΄ μλ” μ†μ„±μ κ°’μ€ μΈκ°€μ„λ²„λ΅ κ¶ν•λ¶€μ—¬ μ”μ²­μ„ ν•κΈ° μ„ν• ClientRegistration ν΄λμ¤μ ν•„λ“μ— μ €μ¥λλ‹¤
5. OAuth2Client λ” ClientRegistration λ¥Ό μ°Έμ΅°ν•΄μ„ κ¶ν•λ¶€μ—¬ μ”μ²­μ„ μ„ν• λ§¤κ°λ³€μλ¥Ό κµ¬μ„±ν•κ³  μΈκ°€μ„λ²„μ™€ ν†µμ‹ ν•λ‹¤

![image](https://github.com/user-attachments/assets/ed8bafa9-db43-4ff9-a9f7-8bf44a921908)

## application.yml

```yaml
spring:
  security:
    oauth2:
      client:
        registration: ## ν΄λΌμ΄μ–ΈνΈ μ„¤μ •
          keycloak:
            authorization-grant-type: authorization_code # OAuth 2.0 κ¶ν• λ¶€μ—¬ νƒ€μ…
            client-id: oauth2-client-app # μ„λΉ„μ¤ κ³µκΈ‰μμ— λ“±λ΅λ ν΄λΌμ΄μ–ΈνΈ μ•„μ΄λ””
            client-name: oauth2-client-app # ν΄λΌμ΄μ–ΈνΈ μ΄λ¦„
            client-secret: tynI8eYUw4H1fJYxwLQ36XhFC1Ge1w1x # μ„λΉ„μ¤ κ³µκΈ‰μμ— λ“±λ΅λ ν΄λΌμ΄μ–ΈνΈ λΉ„λΉλ²νΈ
            redirect-uri: http://localhost:8081/login/oauth2/code/keycloak # μΈκ°€μ„λ²„μ—μ„ κ¶ν• μ½”λ“ λ¶€μ—¬ ν›„ ν΄λΌμ΄μ–ΈνΈλ΅ λ¦¬λ‹¤μ΄λ ‰νΈν•λ” μ„μΉ
            clientAuthenticationMethod: client_secret_post # ν΄λΌμ΄μ–ΈνΈ μκ²©μ¦λ… μ „μ†΅λ°©μ‹
            scope: openid,email # λ¦¬μ†μ¤μ— μ ‘κ·Ό μ ν• λ²”μ„
        provider: ## κ³µκΈ‰μ μ„¤μ •
          keycloak:
            authorization-uri: http://localhost:8080/realms/oauth2/protocol/openid-connect/auth # OAuth 2.0 κ¶ν• μ½”λ“ λ¶€μ—¬ μ—”λ“ ν¬μΈνΈ
            issuer-uri: http://localhost:8080/realms/oauth2 # μ„λΉ„μ¤ κ³µκΈ‰μ μ„μΉ
            jwk-set-uri: http://localhost:8080/realms/oauth2/protocol/openid-connect/certs # OAuth 2.0 JwkSetUri μ—”λ“ ν¬μΈνΈ
            token-uri: http://localhost:8080/realms/oauth2/protocol/openid-connect/token # OAuth 2.0 ν† ν° μ—”λ“ ν¬μΈνΈ
            user-info-uri: http://localhost:8080/realms/oauth2/protocol/openid-connect/userinfo # OAuth 2.0 UserInfo μ—”λ“ ν¬μΈνΈ
            user-name-attribute: preferred_username # OAuth 2.0 μ‚¬μ©μλ…μ„ μ¶”μ¶ν•λ” ν΄λ μ„λ…
```

## OAuth2ClientProperties (prefix = "spring.security.oauth2.clientβ€)

![image](https://github.com/user-attachments/assets/ab54d485-a93a-40d2-81d1-e179b90556cc)

- <b>Registration</b> μ€ μΈκ°€ μ„λ²„μ— λ“±λ΅λ ν΄λΌμ΄μ–ΈνΈ λ° μ”μ²­ νλΌλ―Έν„° μ •λ³΄λ¥Ό λ‚νƒ€λ‚Έλ‹¤
- <b>Provider</b> λ” κ³µκΈ‰μμ—μ„ μ κ³µν•λ” μ—”λ“ν¬μΈνΈ λ“±μ μ •λ³΄λ¥Ό λ‚νƒ€λ‚Έλ‹¤
- ν΄λΌμ΄μ–ΈνΈ λ° κ³µκΈ‰μμ μ •λ³΄λ¥Ό registration / provider λ§µμ— μ €μ¥ν•κ³  μΈκ°€μ„λ²„μ™€μ ν†µμ‹  μ‹ κ° ν•­λ©μ„ μ°Έμ΅°ν•μ—¬ μ‚¬μ©ν•λ‹¤

# ClientRegistration

## κ°λ…

- OAuth 2.0 λλ” OpenID Connect 1.0 Provider μ—μ„ ν΄λΌμ΄μ–ΈνΈμ λ“±λ΅ μ •λ³΄λ¥Ό λ‚νƒ€λ‚Έλ‹¤
- ClientRegistration μ€ OpenID Connect Providerμ μ„¤μ • μ—”λ“ν¬μΈνΈλ‚ μΈκ°€ μ„λ²„μ λ©”νƒ€λ°μ΄ν„° μ—”λ“ν¬μΈνΈλ¥Ό μ°Ύμ•„ μ΄κΈ°ν™”ν•  μ μλ‹¤.
- ClientRegistrationsμ λ©”μ†λ“λ¥Ό μ‚¬μ©ν•λ©΄ μ•„λ μμ μ²λΌ νΈλ¦¬ν•κ² ClientRegistration μ„ μ„¤μ •ν•  μ μλ‹¤
  - ClientRegistration clientRegistration = ClientRegistrations.fromIssuerLocation(β€https://idp.example.com/issuerβ€).build();
  - μ„ μ½”λ“λ” 200 μ‘λ‹µμ„ λ°›μ„ λ•κΉμ§€ https://idp.example.com/issuer/.well-known/openid-configuration, https://idp.example.com/.well-known/oauth-authorization-server μ— μ°¨λ΅€λ€λ΅ μ§μν•΄λ³Έλ‹¤.

![image](https://github.com/user-attachments/assets/e3498914-8272-4d71-bc0d-4bf3500cf6b1)

![image](https://github.com/user-attachments/assets/e7007d9e-18e7-41cd-b564-b266c86df054)

- <b>registrationId</b> : ClientRegistrationμ„ μ‹λ³„ν•  μ μλ” μ λ‹ν¬ν• ID.
- <b>clientId</b> : ν΄λΌμ΄μ–ΈνΈ μ‹λ³„μ.
- <b>clientSecret</b> : ν΄λΌμ΄μ–ΈνΈ secret.
- <b>clientAuthenticationMethod</b> : providerμ—μ„ ν΄λΌμ΄μ–ΈνΈλ¥Ό μΈμ¦ν•  λ• μ‚¬μ©ν•  λ©”μ†λ“λ΅μ„ basic, post, none (public ν΄λΌμ΄μ–ΈνΈ) μ„ μ§€μ›ν•λ‹¤.
- <b>authorizationGrantType</b> : OAuth 2.0 μΈκ°€ ν”„λ μ„μ›ν¬λ” λ„¤ κ°€μ§€ κ¶ν• λ¶€μ—¬ νƒ€μ…μ„ μ •μν•κ³  μμΌλ©° μ§€μ›ν•λ” κ°’μ€ authorization_code, implicit, client_credentials, passwordλ‹¤.
- <b>redirectUriTemplate</b> : ν΄λΌμ΄μ–ΈνΈμ— λ“±λ΅ν• λ¦¬λ‹¤μ΄λ ‰νΈ URLλ΅, μ‚¬μ©μμ μΈμ¦μΌλ΅ ν΄λΌμ΄μ–ΈνΈμ— μ ‘κ·Ό κ¶ν•μ„ λ¶€μ—¬ν•κ³  λ‚λ©΄, μΈκ°€ μ„λ²„κ°€ μ΄ URLλ΅ μµμΆ… μ‚¬μ©μμ λΈλΌμ°μ €λ¥Ό λ¦¬λ‹¤μ΄λ ‰νΈμ‹ν‚¨λ‹¤.
- <b>scopes</b> : μΈκ°€ μ”μ²­ ν”λ΅μ°μ—μ„ ν΄λΌμ΄μ–ΈνΈκ°€ μ”μ²­ν• openid, μ΄λ©”μΌ, ν”„λ΅ν•„ λ“±μ scope.
- <b>clientName</b> : ν΄λΌμ΄μ–ΈνΈλ¥Ό λ‚νƒ€λ‚΄λ” μ΄λ¦„μΌλ΅ μλ™ μƒμ„±λλ” λ΅κ·ΈμΈ νμ΄μ§€μ—μ„ λ…Έμ¶ν•λ” λ“±μ— μ‚¬μ©ν•λ‹¤.
- <b>authorizationUri</b> : μΈκ°€ μ„λ²„μ μΈκ°€ μ—”λ“ν¬μΈνΈ URI.
- <b>tokenUri</b> : μΈκ°€ μ„λ²„μ ν† ν° μ—”λ“ν¬μΈνΈ URI.
- <b>jwkSetUri</b> : μΈκ°€ μ„λ²„μ—μ„ JSON μ›Ή ν‚¤ (JWK) μ…‹μ„ κ°€μ Έμ¬ λ• μ‚¬μ©ν•  URI. μ΄ ν‚¤ μ…‹μ—” ID ν† ν°μ JSON Web Signature (JWS) λ¥Ό κ²€μ¦ν•  λ• μ‚¬μ©ν•  μ•”νΈν‚¤κ°€ μμΌλ©°, UserInfo μ‘λ‹µμ„ κ²€μ¦ν•  λ•λ„ μ‚¬μ©ν•  μ μλ‹¤.
- <b>configurationMetadata</b> : OpenID Provider μ„¤μ • μ •λ³΄λ΅μ„ application.properties μ—spring.security.oauth2.client.provider.[providerId].issuerUriλ¥Ό μ„¤μ •ν–μ„ λ•λ§ μ‚¬μ©ν•  μ μλ‹¤.
- <b>(userInfoEndpoint)uri</b> : μΈμ¦λ μµμΆ… μ‚¬μ©μμ ν΄λ μ„/μ†μ„±μ— μ ‘κ·Όν•  λ• μ‚¬μ©ν•λ” UserInfo μ—”λ“ν¬μΈνΈ URI.
- <b>(userInfoEndpoint)authenticationMethod</b> : UserInfo μ—”λ“ν¬μΈνΈλ΅ μ•΅μ„Έμ¤ ν† ν°μ„ μ „μ†΅ν• λ• μ‚¬μ©ν•  μΈμ¦ λ©”μ†λ“. header, form, query λ¥Ό μ§€μ›ν•λ‹¤.
- <b>userNameAttributeName</b> : UserInfo μ‘λ‹µμ— μλ” μ†μ„± μ΄λ¦„μΌλ΅, μµμΆ… μ‚¬μ©μμ μ΄λ¦„μ΄λ‚ μ‹λ³„μμ— μ ‘κ·Όν•  λ• μ‚¬μ©ν•λ‹¤

![image](https://github.com/user-attachments/assets/fe537698-3ad7-4770-a2b8-2faf7058cbbc)

## CommonOAuth2Provider

![image](https://github.com/user-attachments/assets/5c4b429d-7117-4972-a9f8-8c39d8334266)

- OAuth 2.0 κ³µκΈ‰μ μ •λ³΄λ¥Ό μ κ³µν•λ” ν΄λμ¤λ΅μ„ κΈ€λ΅λ² μ„λΉ„μ¤ μ κ³µμ μΌλ¶€λ” κΈ°λ³ΈμΌλ΅ μ κ³µλμ–΄μ§„λ‹¤
- Client ID μ™€ Client Secret λ” λ³„λ„λ΅ application.properties μ— μ‘μ„±ν•΄μ•Ό ν•λ‹¤.
- Naver λ‚ Kakao μ™€ κ°™μ€ κµ­λ‚΄ κ³µκΈ‰μ μ •λ³΄λ” μ„μ λ¨λ“  ν•­λ©μ„ μλ™μΌλ΅ μ‘μ„±ν•΄μ„ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤
- ν΄λΌμ΄μ–ΈνΈ κΈ°μ¤€μΈ Registration ν•­λ©κ³Ό μ„λΉ„μ¤ μ κ³µμ κΈ°μ¤€μΈ Provider ν•­λ©μΌλ΅ κµ¬λ¶„ν•μ—¬ μ„¤μ •ν•λ‹¤
- application.properties κ°€ μ•„λ‹ Java Config λ°©μ‹μΌλ΅ ClientRegistration λ“±λ΅μ„ μ„¤μ • ν•  μ μλ‹¤
- ClientRegistration κ°μ²΄λ¥Ό μƒμ„±ν•  μ μλ” λΉλ” ν΄λμ¤λ¥Ό λ°ν™ν•λ‹¤

## ClientRegistrationRepository

### κ°λ…

- ClientRegistrationRepository λ” OAuth 2.0 & OpenID Connect 1.0 μ ClientRegistration μ €μ¥μ† μ—­ν• μ„ ν•λ‹¤.
- ν΄λΌμ΄μ–ΈνΈ λ“±λ΅ μ •λ³΄λ” κ¶κ·Ήμ μΌλ΅ μΈκ°€ μ„λ²„κ°€ μ €μ¥ν•κ³  κ΄€λ¦¬ν•λ”λ° μ΄ λ ν¬μ§€ν† λ¦¬λ” μΈκ°€ μ„λ²„μ— μΌμ°¨μ μΌλ΅ μ €μ¥λ ν΄λΌμ΄μ–ΈνΈ λ“±λ΅ μ •λ³΄μ μΌλ¶€λ¥Ό κ²€μƒ‰ν•λ” κΈ°λ¥μ„ μ κ³µν•λ‹¤.
- μ¤ν”„λ§ λ¶€νΈ 2.X μλ™ μ„¤μ •μ€ spring.security.oauth2.client.registration.[registrationId] ν•μ„ ν”„λ΅νΌν‹°λ¥Ό ClientRegistration μΈμ¤ν„΄μ¤μ— λ°”μΈλ”©ν•λ©°, κ° ClientRegistrationκ°μ²΄λ¥Ό ClientRegistrationRepository μ•μ— κµ¬μ„±ν•λ‹¤.
- ClientRegistrationRepository μ λ””ν΄νΈ κµ¬ν„μ²΄λ” InMemoryClientRegistrationRepository λ‹¤.
- μλ™ μ„¤μ •μ„ μ‚¬μ©ν•λ©΄ ClientRegistrationRepository λ„ ApplicationContext λ‚΄ @Bean μΌλ΅ λ“±λ΅ν•λ―€λ΅ ν•„μ”ν•λ‹¤λ©΄ μ›ν•λ” κ³³μ— μμ΅΄μ„±μ„ μ£Όμ…ν•  μ μλ‹¤.

  - μμ΅΄μ„± μ£Όμ… μμ‹

    ```java
    @RestController
    public class IndexPageController {

        @Autowired
        private ClientRegistrationRepository clientRegistrationRepository;

        @GetMapping("/")
        public String index() {
            ClientRegistration clientRegistration =
                this.clientRegistrationRepository.findByRegistrationId("keycloak");
            ...

            return "index";
        }

    }
    ```

## ClientRegistration / ClientRegistrationRepository λΉ λ“±λ΅ν•κΈ°

```java
@Bean
public ClientRegistrationRepository clientRegistrationRepository() {
	return new InMemoryClientRegistrationRepository(this. keycloakClientRegistration());
}

private ClientRegistration keycloakClientRegistration() {
	return ClientRegistration.withRegistrationId("keycloak")
		.clientId("keycloak-client-id")
		.clientSecret(" keycloak-client-secret")
		.clientAuthenticationMethod(ClientAuthenticationMethod.BASIC)
		.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
		.redirectUriTemplate("{baseUrl}/login/oauth2/code/{registrationId}")
		.scope("openid", "profile", "email", "address", "phone")
		.authorizationUri("http://localhost:8080/realms/oauth2")
		.tokenUri("http://localhost:8080/realms/oauth2/token")
		.userInfoUri("http://localhost:8080/realms/oauth2/userinfo")
		.userNameAttributeName(IdTokenClaimNames.SUB)
		.jwkSetUri("http://localhost:8080/realms/oauth2/certs")
		.clientName(β€Keycloak")
		.build();
}
```

# AuthenticationEntryPoint

![image](https://github.com/user-attachments/assets/61f8b3cd-c128-47a3-8894-eb9588ae027a)

# μλ™μ„¤μ •μ— μν• μ΄κΈ°ν™” κ³Όμ •

## OAuth2ImportSelector

![image](https://github.com/user-attachments/assets/48fbef5e-4e7c-49a5-ae27-1af9170531bc)

## OAuth2ClientAutoConfiguration

![image](https://github.com/user-attachments/assets/2fd36dd2-2717-45cc-92bd-cea7352130ac)
