---
layout: single
title: "ğŸŒ»[ìŠ¤í”„ë§ ì‹œíë¦¬í‹° OAuth2] oauth2Login()"
categories:
  - springBoot
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "sidebar-category"
---

# 1. OAuth2LoginConfigurer

## 1-1). OAuth2LoginConfigurer ì´ˆê¸°í™” ë° ì„¤ì •

### ì„¤ì • í´ë˜ìŠ¤ ìƒì„±

```java
@Configuration(proxyBeanMethods = false)
public class CustomOAuth2ClientConfig {

	@Bean
	SecurityFilterChain oauth2SecurityFilterChain(HttpSecurity http) throws Exception {
		http.authorizeRequests((requests) -> requests.anyRequest().authenticated());
		http.oauth2Login(Customizer.withDefaults());
		http.oauth2Client();
		return http.build();
	}
}
```

- API ì„¤ì •
  - SecurityFilterChain íƒ€ì…ì˜ ë¹ˆì„ ìƒì„±í•´ì„œ ë³´ì•ˆ í•„í„°ë¥¼ êµ¬ì„±í•œë‹¤
  - HttpSecurity ì— ìˆëŠ” oauth2Login() ê³¼ oauth2Client() API ë¥¼ ì •ì˜í•˜ê³  ë¹Œë“œí•œë‹¤

![Image](https://github.com/user-attachments/assets/472b5442-01cf-499d-b54a-d097bdf5043b)
![Image](https://github.com/user-attachments/assets/8f74c789-3e23-43a8-9bbf-2311811fd267)
![Image](https://github.com/user-attachments/assets/d5de5438-28a3-4e0d-82f2-543f78d350e2)

# 2. OAuth2 ë¡œê·¸ì¸ êµ¬í˜„

## 2-1). OAuth 2.0 Login Page ìƒì„±

![Image](https://github.com/user-attachments/assets/48abd9b3-f4e1-4b22-8b1c-86093e73cf7b)

## 2-2). Authorization Code ìš”ì²­í•˜ê¸°

### ìš”ì²­ ë§¤í•‘ Url

- AuthorizationRequestMatcher : <b>/oauth2/authorization/{registrationId}\*</b>
- AuthorizationEndpointConfig. authorizationRequestBaseUri ë¥¼ í†µí•´ ì¬ì •ì˜ë  ìˆ˜ ìˆë‹¤

### ì£¼ìš” í´ë˜ìŠ¤

- **OAuth2AuthorizationRequestRedirectFilter**
  - í´ë¼ì´ì–¸íŠ¸ëŠ” ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ì¸ê°€ ì„œë²„ì˜ ê¶Œí•œ ë¶€ì—¬ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•˜ì—¬ ê¶Œí•œ ì½”ë“œ ë¶€ì—¬ íë¦„ì„ ì‹œì‘í•œë‹¤.
  - ![Image](https://github.com/user-attachments/assets/19092761-7177-45a5-ab6d-b6d6a90746d9)
- **DefaultOAuth2AuthorizationRequestResolver**
  - ì›¹ ìš”ì²­ì— ëŒ€í•˜ì—¬ OAuth2AuthorizationRequest ê°ì²´ë¥¼ ìµœì¢… ì™„ì„±í•œë‹¤
  - /oauth2/authorization/{registrationId} ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì„œ ì¼ì¹˜í•˜ë©´ registrationIdë¥¼ ì¶”ì¶œí•˜ê³  ì´ë¥¼ ì‚¬ìš©í•´ì„œ ClientRegistrationì„ ê°€ì ¸ì™€ OAuth2AuthorizationRequest ë¥¼ ë¹Œë“œí•œë‹¤.
  - ![Image](https://github.com/user-attachments/assets/b4e000c5-1bc6-4f7c-83b2-3a17cf150597)
- **OAuth2AuthorizationRequest**
  - í† í° ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ ë‹´ì€ ê°ì²´ë¡œì„œ ì¸ê°€ ì‘ë‹µì„ ì—°ê³„í•˜ê³  ê²€ì¦í•  ë•Œ ì‚¬ìš©í•œë‹¤
  - ![Image](https://github.com/user-attachments/assets/2938c86b-8a5f-4f19-a5cd-8f34b9513fbd)
- **OAuth2AuthorizationRequestRepository**
  - ì¸ê°€ ìš”ì²­ì„ ì‹œì‘í•œ ì‹œì ë¶€í„° ì¸ê°€ ìš”ì²­ì„ ë°›ëŠ” ì‹œì ê¹Œì§€ (ë¦¬ë‹¤ì´ë ‰íŠ¸) OAuth2AuthorizationRequest ë¥¼ ìœ ì§€í•´ì¤€ë‹¤

### Codeë¥¼ ë°›ì•„ì˜¤ê³  ë¦¬ë‹¤ì´ë ‰íŠ¸ ë˜ëŠ” ê³¼ì •

![Image](https://github.com/user-attachments/assets/5125b6e5-93d9-4d81-8295-fcd667df7c81)

## 2-3). Access Token êµí™˜í•˜ê¸°

### ìš”ì²­ ë§¤í•‘ Url

- RequestMatcher : <b>/login/oauth2/code/\*</b>

### ì£¼ìš” í´ë˜ìŠ¤

- **OAuth2LoginAuthenticationFilter**
  - ì¸ê°€ì„œë²„ë¡œë¶€í„° ë¦¬ë‹¤ì´ë ‰íŠ¸ ë˜ë©´ì„œ ì „ë‹¬ëœ code ë¥¼ ì¸ê°€ì„œë²„ì˜ Access Token ìœ¼ë¡œ êµí™˜í•˜ê³  Access Token ì´ ì €ì¥ëœ OAuth2LoginAuthenticationTokenì„ AuthenticationManagerì— ìœ„ì„í•˜ì—¬ UserInfo ì •ë³´ë¥¼ ìš”ì²­í•´ì„œ ìµœì¢… ì‚¬ìš©ìì— ë¡œê·¸ì¸í•œë‹¤.
  - OAuth2AuthorizedClientRepositoryë¥¼ ì‚¬ìš©í•˜ì—¬ OAuth2AuthorizedClient ë¥¼ ì €ì¥í•œë‹¤.
  - ì¸ì¦ì— ì„±ê³µí•˜ë©´ OAuth2AuthenticationToken ì´ ìƒì„±ë˜ê³  SecurityContextì— ì €ì¥ë˜ì–´ ì¸ì¦ ì²˜ë¦¬ë¥¼ ì™„ë£Œí•œë‹¤
  - ![Image](https://github.com/user-attachments/assets/21b59386-1ba0-4182-9bc3-be2acca01cf2)
- **OAuth2LoginAuthenticationProvider**
  - ì¸ê°€ì„œë²„ë¡œë¶€í„° ë¦¬ë‹¤ì´ë ‰íŠ¸ ëœ ì´í›„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì²˜ë¦¬í•˜ë©° Access Token ìœ¼ë¡œ êµí™˜í•˜ê³  ì´ í† í°ì„ ì‚¬ìš©í•˜ì—¬ UserInfo ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•œë‹¤
  - Scope ì— openid ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ OidcAuthorizationCodeAuthenticationProvider ë¥¼ í˜¸ì¶œí•˜ê³  ì•„ë‹ˆë©´ OAuth2AuthorizationCodeAuthenticationProviderë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì œì–´í•œë‹¤
  - ![Image](https://github.com/user-attachments/assets/45ecdfa7-9f2b-4ee1-ac09-86540833bfc0)
- **OAuth2AuthorizationCodeAuthenticationProvider**
  - ê¶Œí•œ ì½”ë“œ ë¶€ì—¬ íë¦„ì„ ì²˜ë¦¬í•˜ëŠ” AuthenticationProvider
  - ì¸ê°€ì„œë²„ì— Authorization Code ì™€ AccessToken ì˜ êµí™˜ì„ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤
  - ![Image](https://github.com/user-attachments/assets/8d19a257-1292-4f8e-8547-a0b590742ee4)
- **OidcAuthorizationCodeAuthenticationProvider**
  - OpenID Connect Core 1.0 ê¶Œí•œ ì½”ë“œ ë¶€ì—¬ íë¦„ì„ ì²˜ë¦¬í•˜ëŠ” AuthenticationProvider ì´ë©° ìš”ì²­ Scope ì— openid ê°€ ì¡´ì¬í•  ê²½ìš° ì‹¤í–‰ëœë‹¤
  - ![Image](https://github.com/user-attachments/assets/74e184f0-f74a-4149-a62e-1343d05e0a26)
- **DefaultAuthorizationCodeTokenResponseClient**
  - ì¸ê°€ì„œë²„ì˜ token ì—”ë“œ í¬ì¸íŠ¸ë¡œ í†µì‹ ì„ ë‹´ë‹¹í•˜ë©° AccessToken ì„ ë°›ì€ í›„ OAuth2AccessTokenResponse ì— ì €ì¥í•˜ê³  ë°˜í™˜í•œë‹¤
  - ![Image](https://github.com/user-attachments/assets/16e8c950-0a93-4683-8c71-618aad96929d)

### êµ¬ì¡°

![Image](https://github.com/user-attachments/assets/9673b2a2-dfc6-48f4-8957-8c0200977bb0)

### íë¦„

![Image](https://github.com/user-attachments/assets/21348fbb-e3fe-4555-a6f3-1d0cdb3e090f)
![Image](https://github.com/user-attachments/assets/c36d87a5-1c5b-4d2e-b140-e8ae7126b54b)

## 2-4). Oauth 2.0 User ëª¨ë¸ ì†Œê°œ

### 2-4-1). OAuth2UserService

- ì•¡ì„¸ìŠ¤ í† í°ì„ ì‚¬ìš©í•´ì„œ UserInfo ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ìœ¼ë¡œ ìµœì¢… ì‚¬ìš©ìì˜ (ë¦¬ì†ŒìŠ¤ ì†Œìœ ì) ì†ì„±ì„ ê°€ì ¸ì˜¤ë©° OAuth2User íƒ€ì…ì˜ ê°ì²´ë¥¼ ë¦¬í„´í•œë‹¤
- êµ¬í˜„ì²´ë¡œ DefaultOAuth2UserService ì™€ OidcUserService ê°€ ì œê³µëœë‹¤

- **DefaultOAuth2UserService**

  - í‘œì¤€ OAuth 2.0 Providerë¥¼ ì§€ì›í•˜ëŠ” OAuth2UserService êµ¬í˜„ì²´ë‹¤
  - OAuth2UserRequest ì— Access Token ì„ ë‹´ì•„ ì¸ê°€ì„œë²„ì™€ í†µì‹  í›„ ì‚¬ìš©ìì˜ ì†ì„±ì„ ê°€ì§€ê³  ì˜¨ë‹¤
  - ìµœì¢… OAuth2User íƒ€ì…ì˜ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤

- **OidcUserService**

  - OpenID Connect 1.0 Providerë¥¼ ì§€ì›í•˜ëŠ” OAuth2UserService êµ¬í˜„ì²´ë‹¤
  - OidcUserRequest ì— ìˆëŠ” ID Token ì„ í†µí•´ ì¸ì¦ ì²˜ë¦¬ë¥¼ í•˜ë©° í•„ìš”ì‹œ DefaultOAuth2UserService ë¥¼ ì‚¬ìš©í•´ì„œ UserInfo ì—”ë“œí¬ì¸íŠ¸ì˜ ì‚¬ìš©ì ì†ì„±ì„ ìš”ì²­í•œë‹¤
  - ìµœì¢… OidcUser íƒ€ì…ì˜ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤

- **íë¦„**
  ![Image](https://github.com/user-attachments/assets/f5ac8510-c59f-42ed-a353-17092e12e8f8)
- **êµ¬ì¡°**
  ![Image](https://github.com/user-attachments/assets/3a4b9e8d-ccc5-4683-bb7c-2236141c37c0)
  - DefaultOAuth2UserService ì€ OAuth2User íƒ€ì…ì˜ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤
  - OidcUserService ì€ OidcUser íƒ€ì…ì˜ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤
  - OidcUserRequest ì˜ ìŠ¹ì¸ëœ í† í°ì— í¬í•¨ë˜ì–´ ìˆëŠ” scope ê°’ì´ accessibleScopes ì˜ ê°’ ë“¤ì¤‘ í•˜ë‚˜ ì´ìƒ í¬í•¨ë˜ì–´ ìˆì„ ê²½ìš° UserInfo ì—”ë“œ í¬ì¸íŠ¸ë¥¼ ìš”ì²­í•œë‹¤

### 2-4-2). OAuth2User & OidcUser

- **ì‹œíë¦¬í‹°ëŠ” UserAttributes ë° ID Token Claims ì„ ì§‘ê³„ & êµ¬ì„±í•˜ì—¬ OAuth2User ì™€ OidcUser íƒ€ì…ì˜ í´ë˜ìŠ¤ë¥¼ ì œê³µí•œë‹¤**

- **OAuth2User**

  - OAuth 2.0 Provider ì— ì—°ê²°ëœ ì‚¬ìš©ì ì£¼ì²´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤
  - ìµœì¢… ì‚¬ìš©ìì˜ ì¸ì¦ì— ëŒ€í•œ ì •ë³´ì¸ Attributes ë¥¼ í¬í•¨í•˜ê³  ìˆìœ¼ë©° first name, middle name, last name, email, phone number, address ë“±ìœ¼ë¡œ êµ¬ì„±ëœë‹¤
  - ê¸°ë³¸ êµ¬í˜„ì²´ëŠ” DefaultOAuth2User ì´ë©° ì¸ì¦ ì´í›„ Authentication ì˜ principal ì†ì„±ì— ì €ì¥ëœë‹¤

- **OidcUser**

  - OAuth2User ë¥¼ ìƒì†í•œ ì¸í„°í˜ì´ìŠ¤ì´ë©° OIDC Provider ì— ì—°ê²°ëœ ì‚¬ìš©ì ì£¼ì²´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤
  - ìµœì¢… ì‚¬ìš©ìì˜ ì¸ì¦ì— ëŒ€í•œ ì •ë³´ì¸ Claims ë¥¼ í¬í•¨í•˜ê³  ìˆìœ¼ë©° OidcIdToken ë° OidcUserInfo ì—ì„œ ì§‘ê³„ ë° êµ¬ì„±ëœë‹¤
  - ê¸°ë³¸ êµ¬í˜„ì²´ëŠ” DefaultOidcUser ì´ë©° DefaultOAuth2User ë¥¼ ìƒì†í•˜ê³  ìˆìœ¼ë©° ì¸ì¦ ì´í›„ Authentication ì˜ principal ì†ì„±ì— ì €ì¥ëœë‹¤

- **íë¦„**
  ![Image](https://github.com/user-attachments/assets/f8dd5d53-0e46-4c5a-bd90-dca17a50d345)
- **êµ¬ì¡°**
  ![Image](https://github.com/user-attachments/assets/35c003b8-8414-4c07-8cdc-3108b70dc956)
  - OAuth 2.0 ë¡œê·¸ì¸ì„ í†µí•´ ì¸ì¦ë°›ì€ ìµœì¢… ì‚¬ìš©ìì˜ Principal ì—ëŠ”OAuth2User í˜¹ì€ OidcUser íƒ€ì…ì˜ ê°ì²´ê°€ ì €ì¥ëœë‹¤
  - ê¶Œí•œ ë¶€ì—¬ ìš”ì²­ ì‹œ scope íŒŒë¼ë¯¸í„°ì— openid ë¥¼ í¬í•¨í–ˆë‹¤ë©´ OidcUser íƒ€ì…ì˜ ê°ì²´ê°€ ìƒì„±ë˜ë©° OidcUser ëŠ” OidcUserInfo ì™€ idToken ì„ ê°€ì§€ê³  ìˆìœ¼ë©° ìµœì¢… ì‚¬ìš©ìì— ëŒ€í•œ Claims ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆë‹¤
  - OAuth2UserAuthority ëŠ” ì¸ê°€ì„œë²„ë¡œë¶€í„° ìˆ˜ì‹ í•œ scope ì •ë³´ë¥¼ ì§‘ê³„í•´ì„œ ê¶Œí•œì •ë³´ë¥¼ êµ¬ì„±í•œë‹¤
  - OidcUser ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ID í† í°ì´ í•„ìš”í•œë° ì´ ë•Œ JSON ì›¹ í† í° (JWT)ìœ¼ë¡œ ëœ ID í† í°ì€ JSON Web Signature (JWS)ë¡œ ì„œëª…ì´ ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ë°˜ë“œì‹œ ì •í•´ì§„ ì•Œê³ ë¦¬ì¦˜ì— ì˜í•œ ê²€ì¦ì´ ì„±ê³µí•˜ë©´ OidcUser ê°ì²´ë¥¼ ìƒì„± í•´ì•¼ í•œë‹¤.

## 2-5). Oauth 2.0 Provider UserInfo ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­í•˜ê¸°

### ìš”ì²­ Uri

- **POST /userinfo**

### ì£¼ìš” í´ë˜ìŠ¤

- **DefaultOAuth2UserService**
  - public OAuth2User loadUser(OAuth2UserRequest userRequest)
- **OAuth2UserRequestEntityConverter**
  - OAuth2UserRequest ë¥¼ RequestEntity ë¡œ ì»¨ë²„í„° í•œë‹¤
  - ![Image](https://github.com/user-attachments/assets/c67e32e0-1cdc-401d-9a50-368ba336533e)
- **RestOperations**
  - RequestEntity ë¡œ ì¸ê°€ì„œë²„ì— ìš”ì²­í•˜ê³  ResponseEntity ë¡œ ì‘ë‹µë°›ëŠ”ë‹¤
  - OAuth2User íƒ€ì…ì˜ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤

### íë¦„

![Image](https://github.com/user-attachments/assets/fc869e5a-30cc-4a3f-8398-7a0a9dd08f56)

## 2-6). OpenID Connect Provider OidcUserInfo ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­í•˜ê¸°

### ìš”ì²­ Uri

- **POST /userinfo**

### ì£¼ìš” í´ë˜ìŠ¤

- **OidcUserService**
  - public OidcUser <b>loadUser</b>(OidcUserRequest userRequest)
    - ![Image](https://github.com/user-attachments/assets/c6ce1150-f0c8-4023-a1a1-bcdbfa26380a)
  - ë‚´ë¶€ì— DefaultOAuth2UserService ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° OIDC ì‚¬ì–‘ì— ë¶€í•©í•  ê²½ìš° OidcUserRequest ë¥¼ ë„˜ê²¨ ì£¼ì–´ ì¸ê°€ì„œë²„ì™€ í†µì‹ í•œë‹¤
  - OidcUser íƒ€ì…ì˜ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤

### íë¦„

![Image](https://github.com/user-attachments/assets/fedeafeb-71a7-401d-922c-196760f541c0)

![Image](https://github.com/user-attachments/assets/88ba91e4-1bed-4171-a7be-b5a1db1a369b)

## 2-7). OpenID Connect ë¡œê·¸ì•„ì›ƒ

### ê°œë…

- í´ë¼ì´ì–¸íŠ¸ëŠ” ë¡œê·¸ì•„ì›ƒ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›¹ ë¸Œë¼ìš°ì €ì— ëŒ€í•œ ì„¸ì…˜ê³¼ ì¿ í‚¤ë¥¼ ì§€ìš´ë‹¤.
- í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í›„ OidcClientInitiatedLogoutSuccessHandler ë¥¼ í˜¸ì¶œí•˜ì—¬ OpenID Provider ì„¸ì…˜ ë¡œê·¸ì•„ì›ƒ ìš”ì²­í•œë‹¤
- OpenID Provider ë¡œê·¸ì•„ì›ƒì´ ì„±ê³µí•˜ë©´ ì§€ì •ëœ ìœ„ì¹˜ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•œë‹¤
- ì¸ê°€ì„œë²„ ë©”íƒ€ë°ì´í„° ì‚¬ì–‘ì— ìˆëŠ” ë¡œê·¸ì•„ì›ƒ ì—”ë“œ í¬ì¸íŠ¸ëŠ” end_session_endpoint ë¡œ ì •ì˜ë˜ì–´ ìˆë‹¤
  - endSessionEndpoint = http://localhost:8080/realms/oauth2/protocol/openid-connect/logout

### API ì„¤ì •

```java
http
    .logout()
    .logoutSuccessHandler(oidcLogoutSuccessHandler())
    .invalidateHttpSession(true)
    .clearAuthentication(true)
    .deleteCookies("JSESSIONID");
```

```java
private OidcClientInitiatedLogoutSuccessHandler oidcLogoutSuccessHandler() {
	OidcClientInitiatedLogoutSuccessHandler successHandler =
		new OidcClientInitiatedLogoutSuccessHandler(clientRegistrationRepository);
	successHandler.setPostLogoutRedirectUri("http://localhost:8081/login");
	return successHandler;
}
```

![Image](https://github.com/user-attachments/assets/7388fa25-7bc7-46f8-a49c-816481fc769f)

## 2-8). Spring MVC ì¸ì¦ ê°ì²´ ì°¸ì¡°í•˜ê¸°

### Authentication

- public void dashboard(<b>Authentication authentication</b>) {}
  - oauth2Login() ë¡œ ì¸ì¦ì„ ë°›ê²Œ ë˜ë©´ Authentication ì€ OAuth2AuthenticationToken íƒ€ì…ì˜ ê°ì²´ë¡œ ë°”ì¸ë”© ëœë‹¤
  - principal ì—ëŠ” OAuth2User íƒ€ì… í˜¹ì€ OidcUser íƒ€ì…ì˜ êµ¬í˜„ì²´ê°€ ì €ì¥ ëœë‹¤.
  - DefaultOAuth2User ëŠ” /userInfo ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ìœ¼ë¡œ ë°›ì€ User í´ë ˆì„ ì •ë³´ë¡œ ìƒì„±ëœ ê°ì²´ì´ë‹¤
  - DefaultOidcUser ëŠ” OpenID Connect ì¸ì¦ì„ í†µí•´ ID Token ë° í´ë ˆì„ ì •ë³´ê°€ í¬í•¨ëœ ê°ì²´ì´ë‹¤

### @AuthenticationPrincipal

- public void dashboard(<b>@AuthenticationPrincipal OAuth2User principal or OidcUser principal</b>) {}
- AuthenticationPrincipalArgumentResolver í´ë˜ìŠ¤ì—ì„œ ìš”ì²­ì„ ê°€ë¡œì±„ì–´ ë°”ì¸ë”© ì²˜ë¦¬ë¥¼ í•œë‹¤.
  - Authentication ë¥¼ SecurityContex ë¡œë¶€í„° êº¼ë‚´ì–´ ì™€ì„œ Principal ì†ì„±ì— OAuth2User í˜¹ì€ OidcUser íƒ€ì…ì˜ ê°ì²´ë¥¼ ì €ì¥í•œë‹¤

# 3. API ì»¤ìŠ¤í…€ ì„¤ì •

## 3-1). Authorization BaseUrl & Redirection BaseUrl

```java
http
	.oauth2Login(oauth2 -> oauth2
		.loginPage("/login")
		.loginProcessingUrl("/login/v1/oauth2/code/*")
		.authorizationEndpoint(authorizationEndpointConfig ->
			authorizationEndpointConfig.baseUri("/oauth2/v1/authorization"))
		.redirectionEndpoint(redirectionEndpointConfig ->
			redirectionEndpointConfig.baseUri("/login/v1/oauth2/code/*"))
	)
;
```

- authorizationEndpoint().<b>baseUrl(â€œ/oauth2/v1/authorizationâ€)</b> ì€ ê¶Œí•œ ë¶€ì—¬ ìš”ì²­ BaseUri ë¥¼ ì»¤ìŠ¤í…€ í•œë‹¤
  - 1ë‹¨ê³„ ê¶Œí•œ ë¶€ì—¬ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” OAuth2AuthorizationRequestRedirectFilter ì—ì„œ ìš”ì²­ì— ëŒ€í•œ ë§¤ì¹­ì—¬ë¶€ë¥¼ íŒë‹¨í•œë‹¤
  - ì„¤ì •ì—ì„œ ë³€ê²½í•œ ê°’ì´ í´ë¼ì´ì–¸íŠ¸ì˜ ë§í¬ ì •ë³´ì™€ ì¼ì¹˜í•˜ë„ë¡ ë§ì¶”ì–´ì•¼ í•œë‹¤
  - ![Image](https://github.com/user-attachments/assets/1ef386b8-2d5b-42b6-b85a-ed11d6a420e8)
- <b>redirectionEndpoint.baseUri("/login/v1/oauth2/code/\*")</b> ì€ ì¸ê°€ ì‘ë‹µì˜ baseUri ë¥¼ ì»¤ìŠ¤í…€ í•œë‹¤
  - Token ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” OAuth2LoginAuthenticationFilter ì—ì„œ ìš”ì²­ì— ëŒ€í•œ ë§¤ì¹­ì—¬ë¶€ë¥¼ íŒë‹¨í•œë‹¤
    - application.yml ì„¤ì • íŒŒì¼ì—ì„œ registration ì†ì„±ì˜ redirectUri ì„¤ì •ì—ë„ ë³€ê²½ëœ ê°’ì„ ì ìš©í•´ì•¼ í•œë‹¤
    - ì¸ê°€ì„œë²„ì˜ redirectUri ì„¤ì •ì—ë„ ë³€ê²½ëœ ê°’ì„ ì ìš©í•´ì•¼ í•œë‹¤
  - loginProcessingUrl("/login/v1/oauth2/code/\*") ë¥¼ ì„¤ì •í•´ë„ ê²°ê³¼ëŠ” ë™ì¼í•˜ì§€ë§Œ redirectionEndpoint.baseUri ê°€ ë” ìš°ì„ ì´ë‹¤
  - ![Image](https://github.com/user-attachments/assets/0db9e189-b71d-4d77-bd61-7868453c7452)

## 3-2). OAuth2AuthorizationRequestResolver

- Authorization Code Grant ë°©ì‹ì—ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ì¸ê°€ì„œë²„ë¡œ ê¶Œí•œë¶€ì—¬ ìš”ì²­í•  ë•Œ ì‹¤í–‰ë˜ëŠ” í´ë˜ìŠ¤
- OAuth2AuthorizationRequestResolver ëŠ” OAuth 2.0 ì¸ê°€ í”„ë ˆì„ì›Œí¬ì— ì •ì˜ëœ í‘œì¤€ íŒŒë¼ë¯¸í„° ì™¸ì— ë‹¤ë¥¸ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ëŠ” ì‹ìœ¼ë¡œ ì¸ê°€ ìš”ì²­ì„ í•  ë•Œ ì‚¬ìš©í•œë‹¤
- DefaultOAuth2AuthorizationRequestResolver ê°€ ë””í´íŠ¸ êµ¬í˜„ì²´ë¡œ ì œê³µ ë˜ë©° Consumer<OAuth2AuthorizationRequest.Builder> ì†ì„±ì— ì»¤ìŠ¤í…€ í•  ë‚´ìš©ì„ êµ¬í˜„í•œë‹¤

```java
@Bean
SecurityFilterChain oauth2SecurityFilterChain(HttpSecurity http) throws Exception {
	http.authorizeRequests((requests) -> requests.antMatchers("/home").permitAll()
		.anyRequest().authenticated());
	http.oauth2Login(authLogin ->
		authLogin.authorizationEndpoint(authEndpoint ->
			authEndpoint.authorizationRequestResolver(customOAuth2AuthenticationRequestResolver())));
	return http.build();
}

private OAuth2AuthorizationRequestResolver customOAuth2AuthenticationRequestResolver() {
	return new CustomOAuth2AuthorizationRequestResolver(clientRegistrationRepository, "/oauth2/authorization");
}
```

![Image](https://github.com/user-attachments/assets/ae998a25-1aed-4b84-b57c-3090e88e6d61)

![Image](https://github.com/user-attachments/assets/4ddbe990-bc15-4e17-a3b5-50f17577c43f)
