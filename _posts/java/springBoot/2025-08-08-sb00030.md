---
layout: single
title: "ğŸ”…[ìŠ¤í”„ë§ ì‹œíë¦¬í‹° OAuth2] oauth2ResourceServer().opaque()"
categories:
  - springBoot
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "sidebar-category"
---

# 1. Opaque ê°œë… ë° API ì„¤ì •

## âœ“ ê°œë…

- Opaque í† í°ì€ ì¸ê°€ ì„œë²„ì—ì„œ í˜¸ìŠ¤íŠ¸í•˜ëŠ” OAuth 2.0 Introspection ì—”ë“œí¬ì¸íŠ¸ë¡œ ê²€ì¦í•œë‹¤.
- Bearer í† í°ì´ ë¦¬ì†ŒìŠ¤ ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ìì²´ ê²€ì¦ì´ë¼ë©´ Opaque í† í°ì€ ì¸ê°€ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ì›ê²© ê²€ì¦ì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤

## âœ“ í™˜ê²½ ì„¤ì •

- ë‘ ê°€ì§€ ì„¤ì •ë§Œ í•˜ë©´ ì¸ê°€ì„œë²„ì™€ì˜ Instrospection ê²€ì¦ì´ ê°€ëŠ¥í•˜ë‹¤.

    â‘   í•„ìš”í•œ ì˜ì¡´ì„±ì„ ì¶”ê°€í•œë‹¤
    ```groovy
    runtimeOnly 'com.nimbusds:oauth2-oidc-sdk:9.35'
    ```

    â‘¡ introspection ì—”ë“œí¬ì¸íŠ¸ ìƒì„¸ ì •ë³´ë¥¼ ì„¤ì •í•œë‹¤
    ```yaml
spring:
    security:
        oauth2:
            resourceserver:
                opaquetoken:
                    introspection-uri: http://localhost:8080/realms/oauth2/protocol/openid-connect/introspect
                    client-id: oauth2-client-app
                    client-secret: CQueEWXZYmv7IIZVxbvh2uwxptXVaRcX
    ```

  - http://localhost:8080/realms/oauth2/protocol/openid-connect/introspect ëŠ” ì¸ê°€ ì„œë²„ê°€ í˜¸ìŠ¤íŠ¸í•˜ëŠ” introspection ì—”ë“œí¬ì¸íŠ¸ì´ë‹¤
  - client-id ì™€ client-secret ì€ ì—”ë“œí¬ì¸íŠ¸ ìš”ì²­ì— ì‚¬ìš©í•  í´ë¼ì´ì–¸íŠ¸ ìê²©ì¦ëª…ì´ë‹¤.

## âœ“ ì„¤ì • í´ë˜ìŠ¤

```java
@Configuration(proxyBeanMethods = false)
static class OAuth2ResourceServerConfig {
    @Bean
    SecurityFilterChain jwtSecurityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeRequests((requests) -> requests.anyRequest().authenticated());
        http.oauth2ResourceServer(OAuth2ResourceServerConfigurer::opaque);
        return http.build();
    }
}
```

## âœ“ OpaqueTokenConfigurer / ì´ˆê¸°í™” ê³¼ì •

<img src="/assets/images/springBoot/image00000035.png">
<br/><br/>

# 2. í† í° ê²€ì‚¬ ë° í”„ë¡œì„¸ìŠ¤ ì´í•´

<img src="/assets/images/springBoot/image00000036.png">

## âœ“ OpaqueTokenIntrospector

- ë¬¸ìì—´ í† í°ì„ RestTemplate ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°€ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ìš”ì²­í•œë‹¤
- í† í°ì´ ê²€ì¦ë˜ë©´ ìµœì¢… OAuth2AuthenticatedPrincipal íƒ€ì…ì˜ ê°ì²´ë¡œ ë””ì½”ë”©í•˜ì—¬ ë°˜í™˜í•œë‹¤.
- OAuth2AuthenticatedPrincipal ì€ BearerTokenAuthentication ì˜ principal ì†ì„±ì— ì €ì¥ëœë‹¤
<br/>

<img src="/assets/images/springBoot/image00000037.png">

## âœ“ CustomOpaqueTokenIntrospector

- OpaqueTokenIntrospector ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ ì»¤ìŠ¤í…€í•œ êµ¬í˜„ì²´ë¥¼ ë§Œë“¤ì–´ ì¬ì •ì˜ í•  ìˆ˜ ìˆë‹¤
- ê²€ì¦ í›„ ë¦¬í„´ íƒ€ì…ì´ OAuth2AuthenticatedPrincipal ì´ê¸° ë•Œë¬¸ì— ì¸ê°€ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ í´ë ˆì„ ì •ë³´ë¥¼ í™œìš©í•´ì„œ ì—¬ëŸ¬ê°€ì§€ ì»¤ìŠ¤í…€í•œ ì‘ì—…ì´ ê°€ëŠ¥í•˜ë‹¤

```java
http 
    .oauth2ResourceServer(oauth2 -> oauth2
        .opaqueToken(opaqueToken -> opaqueToken
            .introspector(customOpaqueTokenIntrospector())
        )
    );
```

```java
@Bean
public OpaqueTokenIntrospector customOpaqueTokenIntrospector() {
    return new CustomOpaqueTokenIntrospector();
}
```

```java
public class CustomOpaqueTokenIntrospector implements OpaqueTokenIntrospector {
    private OpaqueTokenIntrospector delegate = 
        new NimbusOpaqueTokenIntrospector(" http://localhost:8080/realms/oauth2/protocol/openid-connect/introspect ", "client", "secret");

    public OAuth2AuthenticatedPrincipal introspect(String token) {
        OAuth2AuthenticatedPrincipal principal = this.delegate.introspect(token); // ì¸ê°€ì„œë²„ë¡œ ë¶€í„° ë°›ì€ í´ë ˆì„ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ìˆë‹¤
        
        return new DefaultOAuth2AuthenticatedPrincipal(
            principal.getName(), principal.getAttributes(), extractAuthorities(principal)); // ì»¤ìŠ¤í…€í•˜ê²Œ ê¶Œí•œ ë§¤í•‘ í•œë‹¤
    }

    private Collection<GrantedAuthority> extractAuthorities(OAuth2AuthenticatedPrincipal principal) {
        List<String> scopes = principal.getAttribute(OAuth2IntrospectionClaimNames.SCOPE);

        return scopes.stream()
            .map(SimpleGrantedAuthority::new)
            .collect(Collectors.toList());
    }
}
```