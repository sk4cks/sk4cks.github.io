---
layout: single
title: "π§µ[μ¤ν”„λ§ μ‹νλ¦¬ν‹° OAuth2] OAuth 2.0 Resource Server Fundamentals"
categories:
  - springBoot
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "sidebar-category"
---

# 1. OAuth 2.0 Resource Server μ†κ°

## κ°μ”

- OAuth 2.0 μΈκ°€ ν”„λ μ„μ›ν¬μ μ—­ν•  μ¤‘ **ν΄λΌμ΄μ–ΈνΈ λ° μΈκ°€μ„λ²„μ™€μ ν†µμ‹ μ„ λ‹΄λ‹Ήν•λ” λ¦¬μ†μ¤ μ„λ²„μ κΈ°λ¥μ„ ν•„ν„° κΈ°λ°μΌλ΅ κµ¬ν„**ν• λ¨λ“
- κ°„λ‹¨ν• μ„¤μ •λ§μΌλ΅ **ν΄λΌμ΄μ–ΈνΈμ λ¦¬μ†μ¤ μ ‘κ·Ό μ ν•, ν† ν° κ²€μ¦μ„ μ„ν• μΈκ°€μ„λ²„μ™€μ ν†µμ‹  λ“±μ κµ¬ν„μ΄ κ°€λ¥ν•λ‹¤**
- μ–΄ν”λ¦¬μΌ€μ΄μ…μ κ¶ν• κ΄€λ¦¬λ¥Ό λ³„λ„ μΈκ°€ μ„λ²„μ— μ„μ„ν•λ” κ²½μ°μ— μ‚¬μ©ν•  μ μμΌλ©° λ¦¬μ†μ¤ μ„λ²„λ” μ”μ²­μ„ μΈκ°€ν•  λ• μ΄ μΈκ°€ μ„λ²„μ— λ¬Όμ–΄λ³Ό μ μλ‹¤

## OAuth2ResourceServer

- ν΄λΌμ΄μ–ΈνΈμ μ ‘κ·Όμ„ μ ν•ν•λ” μΈκ°€ μ •μ±…μ„ μ„¤μ •ν•λ‹¤
- μΈκ°€μ„λ²„μ—μ„ λ°κΈ‰ν• Access Token μ μ ν¨μ„±μ„ κ²€μ¦ν•κ³  μ ‘κ·Ό λ²”μ„μ— λ”°λΌ μ μ ν• μμ›μ„ μ „λ‹¬ν•λ„λ΅ μ„¤μ •ν•λ‹¤

## JWT

- JWT λ΅ μ „λ‹¬λλ” ν† ν°μ„ κ²€μ¦ν•κΈ° μ„ν• JwtDecoder, BearerTokenAuthenticationFilter, JwtAuthenticationProvider λ“±μ ν΄λμ¤ λ¨λΈλ“¤μ„ μ κ³µν•λ‹¤
- μμ²΄ κ²€μ¦ ν”„λ΅μ„Έμ¤λ¥Ό μ§€μ›ν•λ‹¤

## Opaque

- μΈκ°€μ„λ²„μ introspection μ—”λ“ ν¬μΈνΈλ΅ κ²€μ¦ν•  μ μλ” Opaque ν† ν°μ„ μ§€μ›ν•λ‹¤
- μ‹¤μ‹κ°„μΌλ΅ ν† ν°μ ν™μ„±ν™” μ—¬λ¶€λ¥Ό ν™•μΈν•  μ μλ‹¤

## β“ μμ΅΄μ„± μ¶”κ°€

- λ¦¬μ†μ¤ μ„λ²„λ¥Ό μ§€μ›ν•λ” μ½”λ“λ” λ€λ¶€λ¶„ spring-security-oauth2-resource-server μ— λ“¤μ–΄μλ‹¤. κ·Έλ¬λ‚ JWTλ¥Ό λ””μ½”λ”©ν•κ³  κ²€μ¦ν•λ” λ΅μ§μ€ spring-security-oauth2-jose μ— μλ‹¤. λ”°λΌμ„ λ¦¬μ†μ¤ μ„λ²„κ°€ μ‚¬μ©ν•  Bearer ν† ν°μ„ JWTλ΅ μΈμ½”λ”©ν•λ‹¤λ©΄ λ‘ λ¨λ“μ΄ λ¨λ‘ ν•„μ”ν•λ‹¤.
  ```groovy
  dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
  }
  ```

# 2. application.yml / OAuth2ResourceServerProperties

## ν™κ²½μ„¤μ • νμΌ κµ¬μ„±

1. application. yml ν™κ²½μ„¤μ • νμΌμ— μ•„λ¬΄λ° μ„¤μ •μ„ ν•μ§€ μ•κ³  κΈ°λ™κ²°κ³Όλ¥Ό ν™•μΈν•λ‹¤
2. application. yml ν™κ²½μ„¤μ • νμΌμ— OAuth2 ResourceServer κΈ°λ³Έμ„¤μ • ν›„ κΈ°λ™κ²°κ³Ό ν™•μΈν•λ‹¤

## OAuth2ResourceServerProperties (prefix = β€spring.security.oauth2.resourceserverβ€)

<img src="/assets/images/springBoot/image00000002.png">
- **jwkSetUri** μ€ μΈκ°€ μ„λ²„μ—μ„ μ„λ…ν• ν† ν°μ μ„μΉλ¥Ό λ‚νƒ€λ‚Έλ‹¤
- **issuerUri** λ” μΈκ°€μ„λ²„μ μ„μΉλ¥Ό λ‚νƒ€λ‚Έλ‹¤
- **publicKeyLocation** μ€ κ³µκ°ν‚¤λ¥Ό κ°€μ§€κ³  μλ” νμΌμ μ„μΉλ¥Ό λ‚νƒ€λ‚Έλ‹¤
- **jwsAlgorithm** μ€ JWT ν† ν°μ„ μ„λ…ν•κΈ° μ„ν• μ•κ³ λ¦¬μ¦μ„ λ‚νƒ€λ‚Έλ‹¤
- **IntrospectionUri** λ” ν† ν°μ„ κ²€μ¦ν•κΈ° μ„ν• introspection μ—”λ“ ν¬μΈνΈλ¥Ό λ‚νƒ€λ‚Έλ‹¤

## application. yml μ„¤μ •

```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/realms/oauth2
          jwk-set-uri: http://localhost:8080/realms/oauth2/protocol/openid-connect/certs
```

- **issuer-uri** = http://localhost:8080λ” μΈκ°€ μ„λ²„κ°€ λ°κΈ‰ν•  JWT ν† ν°μ iss ν΄λ μ„μ— μ¶”κ°€λλ” κ°’μΌλ΅μ„ λ°κΈ‰μλ¥Ό λ‚νƒ€λ‚Έλ‹¤.
- **jwk-set-uri** = http://localhost:8080/oauth2/jwksλ” μΈκ°€ μ„λ²„κ°€ λ°κΈ‰ν• JWT ν† ν°μ κ³µκ°ν‚¤ μ •λ³΄λ¥Ό κ²€μƒ‰ν•  μ μλ” μ—”λ“ν¬μΈνΈλ¥Ό λ‚νƒ€λ‚Έλ‹¤.
- λ¦¬μ†μ¤ μ„λ²„λ” μμ²΄ κ²€μ¦ μ„¤μ •μ—λ„ μ΄ μ†μ„±μ„ μ‚¬μ©ν•λ©°, μ΄ μ†μ„±μΌλ΅ μΈκ°€ μ„λ²„μ κ³µκ°ν‚¤λ¥Ό μ°Ύκ³ , κ±΄λ‚΄ λ°›μ€ JWTμ μ ν¨μ„±μ„ κ²€μ‚¬ν•λ‹¤.

## μΈκ°€ μ„λ²„ λ©”νƒ€λ°μ΄ν„° μ—”λ“ν¬μΈνΈ

- issuer-uri ν”„λ΅νΌν‹°λ¥Ό μ‚¬μ©ν•λ ¤λ©΄ μΈκ°€ μ„λ²„κ°€ μ§€μ›ν•λ” μ—”λ“ν¬μΈνΈλ” λ°λ“μ‹ μ…‹ μ¤‘ ν•λ‚μ—¬μ•Ό ν•λ‹¤.
  - https://localhost:8080/issuer/.well-known/openid-configuration
  - https://localhost:8080/.well-known/openid-configuration/issuer
  - https://localhost:8080/.well-known/oauth-authorization-server/issuer
- μ΄ μ—”λ“ν¬μΈνΈλ” **Provider μ„¤μ • μ—”λ“ν¬μΈνΈ** λλ” **μΈκ°€ μ„λ²„ λ©”νƒ€λ°μ΄ν„° μ—”λ“ν¬μΈνΈ**λΌκ³  ν•λ‹¤.

## ResourceServer#Jwt application.yml μ„¤μ • ν•­λ©

```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/realms/oauth2 # μ„λΉ„μ¤ κ³µκΈ‰μ μ„μΉ
          jwk-set-uri: http://localhost:8080/realms/oauth2/protocol/openid-connect/certs # OAuth 2.0 JwkSetUri μ—”λ“ ν¬μΈνΈ
          jws-algorithms: RSA256 # OAuth 2.0 JWS μ„λ… μ•κ³ λ¦¬μ¦
          audiences: http://localhost:8081 # μμ‹ μ μ„μΉ
          public-key-location: classpath:certs/publicKey.txt # OAuth 2.0 JWS κ²€μ¦μ„ μ„ν• PublicKey νμΌ μ„μΉ
```

- μ„ μ†μ„± μ¤‘μ— issuer-uri νΉμ€ jwk-set-uri ν• κ°λ” λ°λ“μ‹ ν•„μ”ν•κ³  λ‚λ¨Έμ§€ μ†μ„±μ€ ν•„μ”μ‹ μ„¤μ •ν•λ©΄ λλ‹¤

# 3. AuthenticationEntryPoint

<img src="/assets/images/springBoot/image00000003.png">

# 4. μλ™μ„¤μ •μ— μν• μ΄κΈ°ν™” κ³Όμ •

<img src="/assets/images/springBoot/image00000004.png">
