---
layout: single
title: "ğŸ”„ï¸ postgresql 15 ì•„ì¹´ì´ë¸Œ ë°±ì—…/ë³µêµ¬"
categories:
  - dbConfig
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "sidebar-category"
---

# 1. ë² ì´ìŠ¤ ë°±ì—…

```bash
# ë² ì´ìŠ¤ ë°±ì—… ë°›ê¸°
pg_basebackup -D /var/lib/pgsql/15/backups/base -Fp -Xs -P

# í™•ì¸
ls -l /var/lib/pgsql/15/backups/base
```

# 2. ì•„ì¹´ì´ë¸Œ ë°±ì—… ì„¤ì •

```bash
# archive í´ë” ìƒì„±
mkdir -p /var/lib/pgsql/15/archive

# postgresql.conf ì„¤ì •
vi /var/lib/pgsql/15/data/postgresql.conf

wal_level = replica
archive_mode = on
archive_command = 'test ! -f /var/lib/pgsql/15/archive/%f && cp %p /var/lib/pgsql/15/archive/%f'
archive_timeout = 60

# postgresql ì„œë¹„ìŠ¤ ì¬ì‹œì‘
sudo systemctl restart postgresql-15

# archive_commandê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
psql -c "select pg_switch_wal();"

# ì•„ì¹´ì´ë¸Œ ë””ë ‰í„°ë¦¬ í™•ì¸
ls -l /var/lib/pgsql/15/archive

# ì•„ì¹´ì´ë¸Œ 7ì¼ ì´ìƒëœ wal ë° ë°±ì—… íŒŒì¼ ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸ ì„¤ì •
vi /usr/local/bin/pg_archive_cleanup.sh

--------------------------------------------------------------------
#!/bin/bash
ARCHIVE_DIR="/var/lib/pgsql/15/archive"
RETENTION_DAYS=7

# ì˜¤ë˜ëœ WAL íŒŒì¼ ì‚­ì œ
find $ARCHIVE_DIR -type f -name "*.backup" -mtime +$RETENTION_DAYS -delete
find $ARCHIVE_DIR -type f -name "0000*" -mtime +$RETENTION_DAYS -delete

# ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
df -h $ARCHIVE_DIR
--------------------------------------------------------------------

# ê¶Œí•œ ì„¤ì •
sudo chmod +x /usr/local/bin/pg_archive_cleanup.sh

# í¬ë¡ ì¡ ì„¤ì •
sudo crontab -u postgres -e

# ë§¤ì¼ ìƒˆë²½ 2ì‹œ ì‹¤í–‰
0 2 * * * /usr/local/bin/pg_archive_cleanup.sh >> /var/log/pg_archive_cleanup.log 2>&1

# ë¡œê·¸ íŒŒì¼ ìƒì„±
touch /var/log/pg_archive_cleanup.log
chown postgres.postgres /var/log/pg_archive_cleanup.log
```

# 3. ì•„ì¹´ì´ë¸Œ ë³µêµ¬

```bash
# DB ì ‘ì†
psql

# í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
CREATE TABLE test_table (id SERIAL, data TEXT);
INSERT INTO test_table (data) VALUES ('test data');

# ìˆ˜ë™ wal ì „í™˜
SELECT pg_switch_wal();
# ì „í™˜í•œ wal íŒŒì¼ ì´ë¦„ ì¡°íšŒ (/var/lib/pgsql/15/archive ì´ ê²½ë¡œì—ì„œ í™•ì¸ê°€ëŠ¥)
SELECT pg_walfile_name(pg_switch_wal());

# postgresql ì„œë²„ ì¢…ë£Œ
sudo systemctl stop postgresql-15

# ê¸°ì¡´ ë°ì´í„° ë””ë ‰í† ë¦¬ ì œê±° ë° ë°±ì—… ë³µì‚¬
mv /var/lib/pgsql/15/data /var/lib/pgsql/15/data_old
cp -rp /var/lib/pgsql/15/backups/base /var/lib/pgsql/15/data
chown -R postgres.postgres /var/lib/pgsql/15/data

# ë² ì´ìŠ¤ ë°±ì—… ë°›ì•˜ë˜ ì‹œì ì´ë‘ ì„¤ì •ì´ ë³€ê²½ëœê±° ìˆìœ¼ë©´ ë™ì¼í•˜ê²Œ ë§ì¶”ê¸°
vi /var/lib/pgsql/15/data/postgresql.conf
vi /var/lib/pgsql/15/data/pg_hba.conf

# ë³µêµ¬ ì»¤ë§¨ë“œ ì ìš©
vi /var/lib/pgsql/15/data/postgresql.conf
##################################################################
restore_command = 'cp /var/lib/pgsql/15/archive/%f %p'
##################################################################

# ë³µêµ¬ ì‹ í˜¸ íŒŒì¼ ìƒì„± (ë³µêµ¬ í›„ì— ìë™ ì‚­ì œë¨)
touch /var/lib/pgsql/15/data/recovery.signal

# íŠ¹ì • ì‹œì ê¹Œì§€ ë³µêµ¬í•˜ë ¤ë©´ postgresql.confì— recovery_target_time ì„¤ì •
# ì œì¼ ìµœì‹ ê¹Œì§€ ë³µêµ¬í•˜ë ¤ë©´ recovery_target_time ì„¤ì • X
vi /var/lib/pgsql/15/data/postgresql.conf
recovery_target_time = '2025-06-03 14:00:00'

# postgresql ì„œë²„ ì‹œì‘
sudo systemctl start postgresql-15

# ë¡œê·¸ í™•ì¸(/var/lib/pgsql/15/data/log/{ì˜¤ëŠ˜ ìš”ì¼ ë¡œê·¸})
database system is ready to accept connections
```
